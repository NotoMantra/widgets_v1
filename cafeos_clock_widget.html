<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Clock Widget</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f5f1eb 0%, #ede4d3 100%);
            padding: 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center;
        }
        .cafe-widget {
            background: linear-gradient(145deg, #faf8f3, #f0ebe0);
            border-radius: 20px; padding: 30px;
            box-shadow: 0 8px 32px rgba(139, 116, 95, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(139, 116, 95, 0.1);
            max-width: 400px; text-align: center; position: relative; overflow: hidden;
        }
        .cafe-widget::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(139, 116, 95, 0.03) 0%, transparent 70%);
            animation: gentle-pulse 8s ease-in-out infinite;
        }
        @keyframes gentle-pulse { 0%,100%{transform:scale(1) rotate(0);opacity:.3} 50%{transform:scale(1.1) rotate(180deg);opacity:.1} }
        .widget-content { position: relative; z-index: 2; }
        .cafe-header { margin-bottom: 25px; }
        .cafe-title { font-size: 20px; color: #8b745f; font-weight: 400; margin-bottom: 8px; line-height: 1.3; }
        .date-text { font-size: 14px; color: #a0906b; font-style: italic; }
        .clock-container {
            position: relative; width: 200px; height: 200px; margin: 20px auto;
            background: radial-gradient(circle, #f7f3ec 0%, #ede4d3 70%, #d4c4a8 100%);
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(139,116,95,.1), 0 4px 20px rgba(139,116,95,.2);
            border: 3px solid #c9b395;
        }
        .hour-mark { position: absolute; width: 2px; height: 15px; background: #8b745f; left: 50%; top: 10px; transform-origin: 50% 90px; margin-left: -1px; }
        .minute-mark { position: absolute; width: 1px; height: 8px; background: #a0906b; left: 50%; top: 14px; transform-origin: 50% 86px; margin-left: -0.5px; }
        .clock-hand { position: absolute !important; background: #8b745f !important; border-radius: 2px !important; transform-origin: 50% 100% !important; left: 50% !important; transition: none !important; }
        .hour-hand { width: 6px !important; height: 60px !important; top: 40px !important; margin-left: -3px !important; z-index: 3 !important; background: #8b745f !important; }
        .minute-hand { width: 4px !important; height: 80px !important; top: 20px !important; margin-left: -2px !important; z-index: 4 !important; background: #8b745f !important; }
        .second-hand { width: 2px !important; height: 85px !important; top: 15px !important; margin-left: -1px !important; background: #d4a574 !important; z-index: 5 !important; }
        .clock-center { position: absolute; width: 12px; height: 12px; background: #8b745f; border-radius: 50%; top: 50%; left: 50%; margin: -6px 0 0 -6px; z-index: 10; box-shadow: 0 0 0 2px #f7f3ec; }
        .coffee-beans { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .bean { width: 8px; height: 12px; background: linear-gradient(45deg, #8b745f, #a0906b); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; opacity: .6; animation: bean-bounce 2s ease-in-out infinite; }
        .bean:nth-child(2){animation-delay:.3s} .bean:nth-child(3){animation-delay:.6s}
        @keyframes bean-bounce { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-5px) scale(1.1)} }
        .quote-section { background: rgba(212,165,116,.08); border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #d4a574; }
        .quote-text { font-size: 14px; color: #6d5d4f; line-height: 1.5; font-style: italic; margin-bottom: 8px; }
        .quote-author { font-size: 11px; color: #8b745f; font-weight: 600; text-align: right; }
        @media (max-width: 480px) {
            .cafe-widget { padding: 20px; margin: 10px; }
            .clock-container { width: 160px; height: 160px; }
            .hour-mark { height: 12px; top: 8px; transform-origin: 50% 72px; }
            .minute-mark { height: 6px; top: 11px; transform-origin: 50% 69px; }
            .hour-hand { height: 48px; top: 32px; }
            .minute-hand { height: 64px; top: 16px; }
            .second-hand { height: 68px; top: 12px; }
        }
    </style>
</head>
<body>
    <div class="cafe-widget">
        <div class="widget-content">
            <div class="cafe-header">
                <h1 class="cafe-title" id="timeGreeting">☕ Good Morning! Rise & Grind ☕</h1>
                <div class="date-text" id="dateText">Loading...</div>
            </div>

            <div class="clock-container" id="clockContainer">
                <div class="clock-hand hour-hand" id="hourHand"></div>
                <div class="clock-hand minute-hand" id="minuteHand"></div>
                <div class="clock-hand second-hand" id="secondHand"></div>
                <div class="clock-center"></div>
            </div>

            <div class="coffee-beans">
                <div class="bean"></div>
                <div class="bean"></div>
                <div class="bean"></div>
            </div>

            <div class="quote-section">
                <div class="quote-text" id="quoteText">Loading inspiration...</div>
                <div class="quote-author" id="quoteAuthor">—</div>
            </div>
        </div>
    </div>

    <script>
        // ====== CONFIG (timezone & resync) ======
        const CONFIG = {
          timeZone:
            new URLSearchParams(location.search).get('tz') ||
            Intl.DateTimeFormat().resolvedOptions().timeZone ||
            'UTC',
          resyncMinutes: 10, // re-sync against server time every N minutes
        };

        // ====== DRIFT-PROOF TIME (server offset) ======
        let serverOffsetMs = 0;

        async function syncServerTime() {
          try {
            // Use HEAD to read server "Date" header; cache-bust to dodge proxies.
            const res = await fetch(`.?_t=${Date.now()}`, {
              method: 'HEAD',
              cache: 'no-store',
            });
            const serverDate = res.headers.get('Date');
            if (serverDate) {
              serverOffsetMs = new Date(serverDate).getTime() - Date.now();
              // console.info('[Clock] Server offset(ms):', serverOffsetMs);
            }
          } catch (e) {
            // If running file:// or blocked, safely ignore and keep using local clock.
            // console.warn('[Clock] Server time sync unavailable, using local time.', e);
          }
        }

        function nowAccurate() {
          return new Date(Date.now() + serverOffsetMs);
        }

        // ====== TIME HELPERS (timezone-aware) ======
        function getTZParts(d = nowAccurate()) {
          const parts = new Intl.DateTimeFormat('en-GB', {
            timeZone: CONFIG.timeZone,
            hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false
          }).formatToParts(d);
          const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
          return { h24: +map.hour, m: +map.minute, s: +map.second };
        }

        function formatDate(d = nowAccurate()) {
          return new Intl.DateTimeFormat('en-US', {
            timeZone: CONFIG.timeZone,
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          }).format(d);
        }

        // ====== QUOTES (unchanged) ======
        const cafeQuotes = [
          { text: "Life is too short for bad coffee and missed opportunities. ☕✨", author: "Anonymous" },
          { text: "Coffee is a hug in a mug, and dreams are fuel for the soul. 🤗☕", author: "Unknown" },
          { text: "Good food, good mood, good life. 🍽️😊", author: "Kitchen Wisdom" },
          { text: "Tea time is me time - steep, sip, and reflect. 🍵🧘", author: "Tea Philosophy" },
          { text: "Fresh cookies make everything better. 🍪❤️", author: "Baker's Truth" },
          { text: "Sandwiches: the perfect handheld happiness. 🥪😄", author: "Lunch Logic" },
          { text: "Life happens, tea helps, cookies comfort. 🍵🍪", author: "Daily Motto" },
          { text: "Behind every successful day is a good breakfast. 🥐🌅", author: "Morning Wisdom" },
          { text: "Soup for the soul, bread for the heart. 🍲🍞", author: "Comfort Food Philosophy" },
          { text: "Sweet treats create sweet memories. 🧁💕", author: "Dessert Wisdom" },
          { text: "Fresh ingredients, fresh perspectives. 🥗🌿", author: "Kitchen Philosophy" },
          { text: "A slice of pie makes everything nice. 🥧✨", author: "Pie Wisdom" },
          { text: "Hot chocolate: liquid sunshine for cloudy days. 🍫☀️", author: "Cozy Corner" },
          { text: "Good food shared is love multiplied. 🍽️❤️", author: "Community Kitchen" },
          { text: "Pancakes: fluffy clouds of breakfast joy. 🥞☁️", author: "Morning Magic" }
        ];

        function getTimeBasedGreeting() {
          const { h24 } = getTZParts();
          if (h24 >= 5 && h24 < 11) {
            const a = ["☕ Good Morning! Rise & Grind ☕","🌅 Fresh Coffee & Pastries! 🥐","🧇 Breakfast Bliss Awaits! 🧇","🥐 Croissants & Coffee Time! ☕","🥯 Bagels & Fresh Brew! 🥯","🍳 Morning Treats Ready! 🍳","🥞 Pancakes & Hot Coffee! ☕"];
            return a[Math.floor(Math.random()*a.length)];
          } else if (h24 >= 11 && h24 < 14) {
            const a = ["🍽️ Hungry? It's Lunch Time! 🍽️","🥪 Fresh Sandwiches & Soup! 🍲","🌯 Wraps & Smoothies Ready! 🥤","🍕 Pizza & Iced Tea! 🧊","🥗 Fresh Salads & Paninis! 🥖","🍜 Warm Soup & Bread! 🍞","🌮 Tasty Lunch Combos! 🌮"];
            return a[Math.floor(Math.random()*a.length)];
          } else if (h24 >= 14 && h24 < 17) {
            const a = ["🍰 Afternoon Treats & Tea! 🍵","🧁 Cupcakes & Cappuccino! ☕","🍪 Fresh Cookies & Coffee! 🍪","🍩 Donuts & Hot Chocolate! 🍫","🥧 Pie Slice & Latte! ☕","🍓 Berry Tarts & Tea! 🫖","🍦 Ice Cream & Cold Brew! 🧊"];
            return a[Math.floor(Math.random()*a.length)];
          } else if (h24 >= 17 && h24 < 21) {
            const a = ["🌆 Evening Bites & Wine! 🍷","🍵 Herbal Tea & Scones! 🫖","🥧 Dinner Specials Ready! 🍽️","🍝 Pasta & Garlic Bread! 🧄","🥘 Hearty Stews & Rolls! 🥖","🧀 Cheese Boards & Tea! 🍵","🍷 Wine & Light Bites! 🫒"];
            return a[Math.floor(Math.random()*a.length)];
          } else {
            const a = ["🌙 Late Night Comfort Food! 🌙","☕ Decaf & Sweet Treats! 🍪","🍪 Midnight Cookies & Milk! 🥛","🌟 Cozy Night Snacks! 🥨","🍫 Hot Chocolate & Marshmallows! 🤍","🫖 Chamomile Tea & Biscuits! 🍪","🍰 Night Owl Desserts! 🦉"];
            return a[Math.floor(Math.random()*a.length)];
          }
        }

        // ====== CLOCK FACE (unchanged) ======
        function createClockFace() {
          const container = document.getElementById('clockContainer');
          for (let i = 0; i < 12; i++) {
            const mark = document.createElement('div');
            mark.className = 'hour-mark';
            mark.style.transform = `rotate(${i * 30}deg)`;
            container.appendChild(mark);
          }
          for (let i = 0; i < 60; i++) {
            if (i % 5 !== 0) {
              const mark = document.createElement('div');
              mark.className = 'minute-mark';
              mark.style.transform = `rotate(${i * 6}deg)`;
              container.appendChild(mark);
            }
          }
        }

        // ====== RENDER FUNCTIONS (timezone + drift-proof) ======
        function updateClock() {
          const { h24, m, s } = getTZParts();
          const hours12 = h24 % 12;

          const secondAngle = (s * 6) - 90;
          const minuteAngle = (m * 6) - 90;
          const hourAngle   = (hours12 * 30) + (m * 0.5) - 90;

          const hourHand = document.getElementById('hourHand');
          const minuteHand = document.getElementById('minuteHand');
          const secondHand = document.getElementById('secondHand');

          if (hourHand && minuteHand && secondHand) {
            // Rebuild styles to avoid CSS conflicts (keeps your original approach)
            hourHand.style.cssText = `
              position: absolute !important; width: 6px !important; height: 60px !important; top: 40px !important;
              left: 50% !important; margin-left: -3px !important; background: #8b745f !important; border-radius: 2px !important;
              transform-origin: 50% 100% !important; transform: rotate(${hourAngle}deg) !important; z-index: 3 !important;
            `;
            minuteHand.style.cssText = `
              position: absolute !important; width: 4px !important; height: 80px !important; top: 20px !important;
              left: 50% !important; margin-left: -2px !important; background: #8b745f !important; border-radius: 2px !important;
              transform-origin: 50% 100% !important; transform: rotate(${minuteAngle}deg) !important; z-index: 4 !important;
            `;
            secondHand.style.cssText = `
              position: absolute !important; width: 2px !important; height: 85px !important; top: 15px !important;
              left: 50% !important; margin-left: -1px !important; background: #d4a574 !important; border-radius: 2px !important;
              transform-origin: 50% 100% !important; transform: rotate(${secondAngle}deg) !important; z-index: 5 !important;
            `;
          }
        }

        function updateDate() {
          document.getElementById('dateText').textContent = formatDate();
          document.getElementById('timeGreeting').textContent = getTimeBasedGreeting();
        }

        function setRandomQuote() {
          const q = cafeQuotes[Math.floor(Math.random() * cafeQuotes.length)];
          document.getElementById('quoteText').textContent = q.text;
          document.getElementById('quoteAuthor').textContent = `— ${q.author}`;
        }

        // ====== TICKERS (aligned to whole second/minute) ======
        function startClockTicker() {
          const tick = () => {
            updateClock();
            const ms = (new Date(Date.now() + serverOffsetMs)).getMilliseconds();
            setTimeout(tick, 1000 - ms);
          };
          tick();
        }

        function startDateTicker() {
          const msNow = (Date.now() + serverOffsetMs) % 60000;
          const untilNextMinute = 60000 - msNow;
          setTimeout(() => {
            updateDate();
            setInterval(updateDate, 60000);
          }, untilNextMinute);
        }

        // ====== VISIBILITY/FOCUS HANDLERS ======
        function forceTimeUpdate() {
          updateClock();
          updateDate();
        }
        function handleVisibilityChange() {
          if (!document.hidden) {
            syncServerTime().finally(forceTimeUpdate);
          }
        }

        // ====== INIT ======
        async function init() {
          createClockFace();
          setRandomQuote();

          await syncServerTime();     // get server offset first (if available)
          forceTimeUpdate();          // initial render with accurate time
          startClockTicker();         // aligned seconds
          startDateTicker();          // aligned minutes

          // Quote refresh every 30 minutes
          setInterval(setRandomQuote, 30 * 60 * 1000);

          // Periodically re-sync server time
          setInterval(syncServerTime, CONFIG.resyncMinutes * 60 * 1000);

          // Also refresh on focus/visibility change
          document.addEventListener('visibilitychange', handleVisibilityChange);
          window.addEventListener('focus', () => { syncServerTime().finally(forceTimeUpdate); });

          // Optional: log which timezone is used
          // console.info('[Clock] Using timezone:', CONFIG.timeZone);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
