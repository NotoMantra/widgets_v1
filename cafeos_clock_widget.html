<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cafe Clock Widget</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Georgia','Times New Roman',serif;
      background:linear-gradient(135deg,#f5f1eb 0%,#ede4d3 100%);
      padding:20px;min-height:100vh;display:flex;align-items:center;justify-content:center
    }
    .cafe-widget{
      background:linear-gradient(145deg,#faf8f3,#f0ebe0);
      border-radius:20px;padding:30px;
      box-shadow:0 8px 32px rgba(139,116,95,.15), inset 0 1px 0 rgba(255,255,255,.8);
      border:1px solid rgba(139,116,95,.1);max-width:400px;text-align:center;position:relative;overflow:hidden
    }
    .cafe-widget::before{
      content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
      background:radial-gradient(circle,rgba(139,116,95,.03) 0%,transparent 70%);
      animation:gentle-pulse 8s ease-in-out infinite
    }
    @keyframes gentle-pulse{0%,100%{transform:scale(1) rotate(0);opacity:.3}50%{transform:scale(1.1) rotate(180deg);opacity:.1}}
    .widget-content{position:relative;z-index:2}
    .cafe-header{margin-bottom:16px}
    .cafe-title{font-size:20px;color:#8b745f;font-weight:400;margin-bottom:8px;line-height:1.3}
    .date-text{font-size:14px;color:#a0906b;font-style:italic}
    .timezone-selector{margin-top:8px}
    .timezone-selector select{
      background:rgba(139,116,95,.1);border:1px solid rgba(139,116,95,.3);
      border-radius:6px;padding:4px 8px;font-size:11px;color:#8b745f;font-family:inherit;cursor:pointer;transition:.2s
    }
    .timezone-selector select:hover{background:rgba(139,116,95,.15);border-color:rgba(139,116,95,.5)}
    .timezone-selector select:focus{outline:none;border-color:#8b745f;box-shadow:0 0 0 2px rgba(139,116,95,.2)}
    .sync-status{font-size:10px;color:#a0906b;margin-top:4px;text-align:center;transition:color .3s ease}

    .clock-container{
      position:relative;width:200px;height:200px; /* base; JS will adapt */
      margin:14px auto 20px;
      background:radial-gradient(circle,#f7f3ec 0%,#ede4d3 70%,#d4c4a8 100%);
      border-radius:50%;box-shadow:inset 0 0 20px rgba(139,116,95,.1),0 4px 20px rgba(139,116,95,.2);
      border:3px solid #c9b395
    }

    /* Mark + hand base styles; dimensions/positions are set dynamically */
    .hour-mark,.minute-mark{position:absolute;left:50%;background:#8b745f}
    .minute-mark{background:#a0906b}
    .clock-hand{
      position:absolute !important;background:#8b745f !important;border-radius:2px !important;
      transform-origin:50% 100% !important;left:50% !important;transition:none !important
    }
    .second-hand{background:#d4a574 !important}
    .clock-center{
      position:absolute;width:12px;height:12px;background:#8b745f;border-radius:50%;
      top:50%;left:50%;margin:-6px 0 0 -6px;z-index:10;box-shadow:0 0 0 2px #f7f3ec
    }

    .coffee-beans{display:flex;justify-content:center;gap:10px;margin:15px 0}
    .bean{width:8px;height:12px;background:linear-gradient(45deg,#8b745f,#a0906b);border-radius:50% 50% 50% 50%/60% 60% 40% 40%;opacity:.6;animation:bean-bounce 2s ease-in-out infinite}
    .bean:nth-child(2){animation-delay:.3s}.bean:nth-child(3){animation-delay:.6s}
    @keyframes bean-bounce{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-5px) scale(1.1)}}
    .quote-section{background:rgba(212,165,116,.08);border-radius:12px;padding:20px;margin:10px 0 0;border-left:4px solid #d4a574}
    .quote-text{font-size:14px;color:#6d5d4f;line-height:1.5;font-style:italic;margin-bottom:8px}
    .quote-author{font-size:11px;color:#8b745f;font-weight:600;text-align:right}

    @media (max-width:480px){
      .cafe-widget{padding:20px;margin:10px}
      .clock-container{width:160px;height:160px}
    }
  </style>
</head>
<body>
  <div class="cafe-widget">
    <div class="widget-content">
      <div class="cafe-header">
        <h1 class="cafe-title" id="timeGreeting">‚òï Good Morning! Rise & Grind ‚òï</h1>
        <div class="date-text" id="dateText">Loading...</div>

        <div class="timezone-selector">
          <select id="timezoneSelect">
            <option value="auto">Auto (Device Time)</option>
            <option value="America/New_York">New York (ET)</option>
            <option value="America/Los_Angeles">Los Angeles (PT)</option>
            <option value="Europe/London">London (UK)</option>
            <option value="Europe/Paris">Paris (FR)</option>
            <option value="Asia/Kolkata">India (IST)</option>
            <option value="Asia/Dubai">Dubai (GST)</option>
            <option value="Asia/Tokyo">Tokyo (JST)</option>
            <option value="Australia/Sydney">Sydney (AET)</option>
          </select>
          <div class="sync-status" id="syncStatus">üåê Syncing with network time‚Ä¶</div>
        </div>
      </div>

      <div class="clock-container" id="clockContainer">
        <div class="clock-hand hour-hand" id="hourHand"></div>
        <div class="clock-hand minute-hand" id="minuteHand"></div>
        <div class="clock-hand second-hand" id="secondHand"></div>
        <div class="clock-center"></div>
      </div>

      <div class="coffee-beans"><div class="bean"></div><div class="bean"></div><div class="bean"></div></div>

      <div class="quote-section">
        <div class="quote-text" id="quoteText">Loading inspiration...</div>
        <div class="quote-author" id="quoteAuthor">‚Äî</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Quotes =====
    const cafeQuotes = [
      { text: "Life is too short for bad coffee and missed opportunities. ‚òï‚ú®", author: "Anonymous" },
      { text: "Coffee is a hug in a mug, and dreams are fuel for the soul. ü§ó‚òï", author: "Unknown" },
      { text: "Good food, good mood, good life. üçΩÔ∏èüòä", author: "Kitchen Wisdom" },
      { text: "Tea time is me time - steep, sip, and reflect. üçµüßò", author: "Tea Philosophy" },
      { text: "Fresh cookies make everything better. üç™‚ù§Ô∏è", author: "Baker's Truth" },
      { text: "Sandwiches: the perfect handheld happiness. ü•™üòÑ", author: "Lunch Logic" },
      { text: "Life happens, tea helps, cookies comfort. üçµüç™", author: "Daily Motto" },
      { text: "Behind every successful day is a good breakfast. ü•êüåÖ", author: "Morning Wisdom" },
      { text: "Soup for the soul, bread for the heart. üç≤üçû", author: "Comfort Food Philosophy" },
      { text: "Sweet treats create sweet memories. üßÅüíï", author: "Dessert Wisdom" },
      { text: "Fresh ingredients, fresh perspectives. ü•óüåø", author: "Kitchen Philosophy" },
      { text: "A slice of pie makes everything nice. ü•ß‚ú®", author: "Pie Wisdom" },
      { text: "Hot chocolate: liquid sunshine for cloudy days. üç´‚òÄÔ∏è", author: "Cozy Corner" },
      { text: "Good food shared is love multiplied. üçΩÔ∏è‚ù§Ô∏è", author: "Community Kitchen" },
      { text: "Pancakes: fluffy clouds of breakfast joy. ü•û‚òÅÔ∏è", author: "Morning Magic" }
    ];

    // ===== Config =====
    const urlTZ = new URLSearchParams(location.search).get('tz');
    let selectedTimezone = urlTZ || 'auto';  // default: device time
    const RESYNC_MIN = 10;
    const MAX_TRUSTED_SKEW_MS = 2 * 60 * 1000; // guard against bad headers/caches

    // ===== Accurate time via network (CDN-safe) =====
    let serverOffsetMs = 0;
    let lastSyncOK = false;
    let lastSyncAt = null;

    async function syncAccurateTime() {
      try {
        const t0 = performance.now();
        const res = await fetch(`./?_t=${Date.now()}`, { method: 'HEAD', cache: 'no-store' });
        const t1 = performance.now();
        const dateHdr = res.headers.get('Date');
        if (dateHdr) {
          const baseMs  = new Date(dateHdr).getTime();
          const halfRTT = Math.round((t1 - t0) / 2);
          const estNow  = baseMs + halfRTT; // ‚úÖ ignore Age to avoid double counting cache time
          serverOffsetMs = estNow - Date.now();

          // Guard: ignore absurd skews (prevents sudden big jumps)
          if (Math.abs(serverOffsetMs) > MAX_TRUSTED_SKEW_MS) {
            serverOffsetMs = 0;
            lastSyncOK = false; lastSyncAt = new Date(); updateSyncStatus();
            return;
          }

          lastSyncOK = true; lastSyncAt = new Date(); updateSyncStatus();
          return;
        }
      } catch {}

      // Fallback: WorldTimeAPI
      try {
        const t0 = performance.now();
        const r = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC', { cache: 'no-store' });
        const t1 = performance.now();
        if (r.ok) {
          const j = await r.json();
          if (j && typeof j.unixtime === 'number') {
            const halfRTT = Math.round((t1 - t0) / 2);
            const estUtcMs = j.unixtime * 1000 + halfRTT;
            serverOffsetMs = estUtcMs - Date.now();

            if (Math.abs(serverOffsetMs) > MAX_TRUSTED_SKEW_MS) {
              serverOffsetMs = 0;
              lastSyncOK = false; lastSyncAt = new Date(); updateSyncStatus();
              return;
            }

            lastSyncOK = true; lastSyncAt = new Date(); updateSyncStatus();
            return;
          }
        }
      } catch {}

      serverOffsetMs = 0; lastSyncOK = false; lastSyncAt = new Date(); updateSyncStatus();
    }
    const nowAccurate = () => new Date(Date.now() + serverOffsetMs);

    // ===== TZ helpers =====
    function getPartsForTZ(tz) {
      const d = nowAccurate();
      if (tz === 'auto') return { h24:d.getHours(), m:d.getMinutes(), s:d.getSeconds(), date:d };
      try {
        const parts = new Intl.DateTimeFormat('en-GB', {
          timeZone: tz, hour:'numeric', minute:'numeric', second:'numeric', hour12:false
        }).formatToParts(d);
        const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
        return { h24:+map.hour, m:+map.minute, s:+map.second, date:d };
      } catch { return { h24:d.getHours(), m:d.getMinutes(), s:d.getSeconds(), date:d }; }
    }
    function formatDateForTZ(tz) {
      const d = nowAccurate();
      try {
        return new Intl.DateTimeFormat('en-US', {
          timeZone: tz === 'auto' ? undefined : tz,
          weekday:'long', year:'numeric', month:'long', day:'numeric'
        }).format(d);
      } catch {
        return d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      }
    }
    function formatTimeForTZ(tz) {
      const d = nowAccurate();
      try {
        return new Intl.DateTimeFormat('en-US', {
          timeZone: tz === 'auto' ? undefined : tz,
          hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true
        }).format(d);
      } catch { return d.toLocaleTimeString('en-US'); }
    }

    // ===== Greeting (sticky per time block) =====
    let lastGreetingBlock = null;
    let lastGreetingText = "‚òï Good Morning! Rise & Grind ‚òï";

    function getTimeBlock(h24){
      if (h24 >= 5 && h24 < 11) return 'morning';
      if (h24 >= 11 && h24 < 14) return 'lunch';
      if (h24 >= 14 && h24 < 17) return 'afternoon';
      if (h24 >= 17 && h24 < 21) return 'evening';
      return 'night';
    }

    function getTimeBasedGreeting() {
      const { h24 } = getPartsForTZ(selectedTimezone);
      const block = getTimeBlock(h24);

      if (block === lastGreetingBlock) {
        return lastGreetingText; // keep it stable within the block
      }

      let a;
      if (block === 'morning') {
        a = ["‚òï Good Morning! Rise & Grind ‚òï","üåÖ Fresh Coffee & Pastries! ü•ê","üßá Breakfast Bliss Awaits! üßá","ü•ê Croissants & Coffee Time! ‚òï","ü•Ø Bagels & Fresh Brew! ü•Ø","üç≥ Morning Treats Ready! üç≥","ü•û Pancakes & Hot Coffee! ‚òï"];
      } else if (block === 'lunch') {
        a = ["üçΩÔ∏è Hungry? It's Lunch Time! üçΩÔ∏è","ü•™ Fresh Sandwiches & Soup! üç≤","üåØ Wraps & Smoothies Ready! ü•§","üçï Pizza & Iced Tea! üßä","ü•ó Fresh Salads & Paninis! ü•ñ","üçú Warm Soup & Bread! üçû","üåÆ Tasty Lunch Combos! üåÆ"];
      } else if (block === 'afternoon') {
        a = ["üç∞ Afternoon Treats & Tea! üçµ","üßÅ Cupcakes & Cappuccino! ‚òï","üç™ Fresh Cookies & Coffee! üç™","üç© Donuts & Hot Chocolate! üç´","ü•ß Pie Slice & Latte! ‚òï","üçì Berry Tarts & Tea! ü´ñ","üç¶ Ice Cream & Cold Brew! üßä"];
      } else if (block === 'evening') {
        a = ["üåÜ Evening Bites & Wine! üç∑","üçµ Herbal Tea & Scones! ü´ñ","ü•ß Dinner Specials Ready! üçΩÔ∏è","üçù Pasta & Garlic Bread! üßÑ","ü•ò Hearty Stews & Rolls! ü•ñ","üßÄ Cheese Boards & Tea! üçµ","üç∑ Wine & Light Bites! ü´í"];
      } else {
        a = ["üåô Late Night Comfort Food! üåô","‚òï Decaf & Sweet Treats! üç™","üç™ Midnight Cookies & Milk! ü•õ","üåü Cozy Night Snacks! ü•®","üç´ Hot Chocolate & Marshmallows! ü§ç","ü´ñ Chamomile Tea & Biscuits! üç™","üç∞ Night Owl Desserts! ü¶â"];
      }

      lastGreetingBlock = block;
      lastGreetingText = a[Math.floor(Math.random() * a.length)];
      return lastGreetingText;
    }

    // ===== Clock face =====
    function createClockFace() {
      const container = document.getElementById('clockContainer');
      // Hour marks
      for (let i=0;i<12;i++){
        const mark=document.createElement('div');
        mark.className='hour-mark';
        mark.style.transform=`rotate(${i*30}deg)`;
        container.appendChild(mark);
      }
      // Minute marks
      for (let i=0;i<60;i++){
        if (i%5!==0){
          const mark=document.createElement('div');
          mark.className='minute-mark';
          mark.style.transform=`rotate(${i*6}deg)`;
          container.appendChild(mark);
        }
      }
    }

    // ===== Responsive geometry =====
    function layoutDial() {
      const box = document.getElementById('clockContainer');
      const size = Math.min(box.clientWidth, box.clientHeight);
      const R = size/2;

      // Hand lengths (relative to size)
      const lenHour = Math.round(size * 0.30);
      const lenMin  = Math.round(size * 0.40);
      const lenSec  = Math.round(size * 0.425);

      const wHour = Math.max(2, Math.round(size * 0.03));
      const wMin  = Math.max(2, Math.round(size * 0.02));
      const wSec  = Math.max(1, Math.round(size * 0.01));

      const hourHand = document.getElementById('hourHand');
      const minuteHand = document.getElementById('minuteHand');
      const secondHand = document.getElementById('secondHand');

      // Position the hands so their pivot (bottom) is exactly at center
      hourHand.style.height = `${lenHour}px`;
      hourHand.style.top = `${R - lenHour}px`;
      hourHand.style.width = `${wHour}px`;
      hourHand.style.marginLeft = `${-wHour/2}px`;
      hourHand.style.zIndex = 3;

      minuteHand.style.height = `${lenMin}px`;
      minuteHand.style.top = `${R - lenMin}px`;
      minuteHand.style.width = `${wMin}px`;
      minuteHand.style.marginLeft = `${-wMin/2}px`;
      minuteHand.style.zIndex = 4;

      secondHand.style.height = `${lenSec}px`;
      secondHand.style.top = `${R - lenSec}px`;
      secondHand.style.width = `${wSec}px`;
      secondHand.style.marginLeft = `${-wSec/2}px`;
      secondHand.style.zIndex = 5;

      // Marks (distance from center & sizes scale with radius)
      const hourMarks = box.querySelectorAll('.hour-mark');
      const minuteMarks = box.querySelectorAll('.minute-mark');

      const hourMarkH = Math.max(6, Math.round(size * 0.075)); // ~15px at 200
      const minMarkH  = Math.max(3, Math.round(size * 0.04));  // ~8px  at 200
      const hourTop   = Math.round(size * 0.05);               // ~10px at 200
      const minTop    = Math.round(size * 0.07);               // ~14px at 200
      const hourOrigin= (R * 0.90);                            // 90px when R=100
      const minOrigin = (R * 0.86);                            // 86px when R=100

      hourMarks.forEach(m=>{
        m.style.width = '2px';
        m.style.height = `${hourMarkH}px`;
        m.style.top = `${hourTop}px`;
        m.style.marginLeft = '-1px';
        m.style.transformOrigin = `50% ${hourOrigin}px`;
      });
      minuteMarks.forEach(m=>{
        m.style.width = '1px';
        m.style.height = `${minMarkH}px`;
        m.style.top = `${minTop}px`;
        m.style.marginLeft = '-0.5px';
        m.style.transformOrigin = `50% ${minOrigin}px`;
      });
    }

    // Re-layout on size changes
    let ro;
    function watchResize() {
      const box = document.getElementById('clockContainer');
      if (ro) ro.disconnect();
      ro = new ResizeObserver(() => { layoutDial(); updateClock(); });
      ro.observe(box);
    }

    // ===== Rendering (0¬∞ = 12 o‚Äôclock) =====
    function updateClock() {
      const { h24, m, s } = getPartsForTZ(selectedTimezone);
      const h12 = h24 % 12;

      const secondAngle = s * 6;
      const minuteAngle = m * 6;
      const hourAngle   = (h12 * 30) + (m * 0.5);

      document.getElementById('hourHand').style.transform   = `rotate(${hourAngle}deg)`;
      document.getElementById('minuteHand').style.transform = `rotate(${minuteAngle}deg)`;
      document.getElementById('secondHand').style.transform = `rotate(${secondAngle}deg)`;

      updateSyncStatus();
    }

    function updateDate() {
      document.getElementById('dateText').textContent = formatDateForTZ(selectedTimezone);
      document.getElementById('timeGreeting').textContent = getTimeBasedGreeting();
    }
    function setRandomQuote() {
      const q = cafeQuotes[Math.floor(Math.random()*cafeQuotes.length)];
      document.getElementById('quoteText').textContent = q.text;
      document.getElementById('quoteAuthor').textContent = `‚Äî ${q.author}`;
    }

    // ===== Status UI =====
    function updateSyncStatus() {
      const el = document.getElementById('syncStatus');
      if (!el) return;
      const nowStr = formatTimeForTZ(selectedTimezone);
      if (lastSyncOK) { el.textContent = `‚úÖ Network time synced ‚Ä¢ ${nowStr}`; el.style.color = '#8b745f'; }
      else { el.textContent = `Using device time ‚Ä¢ ${nowStr}`; el.style.color = '#8b745f'; }
    }

    // ===== Tickers aligned to whole second/minute =====
    function startClockTicker() {
      const align = 1000 - (nowAccurate().getTime() % 1000);
      setTimeout(function tick() {
        updateClock();
        const ms = nowAccurate().getMilliseconds();
        setTimeout(tick, 1000 - ms);
      }, align);
    }
    function startDateTicker() {
      const msToNextMinute = 60000 - (nowAccurate().getTime() % 60000);
      setTimeout(() => {
        updateDate();
        setInterval(updateDate, 60000);
      }, msToNextMinute);
    }

    // ===== Timezone selector =====
    function applyInitialTimezoneSelect() {
      const sel = document.getElementById('timezoneSelect');
      if (selectedTimezone !== 'auto' && ![...sel.options].some(o => o.value === selectedTimezone)) {
        const opt = document.createElement('option'); opt.value = selectedTimezone; opt.textContent = selectedTimezone; sel.appendChild(opt);
      }
      sel.value = selectedTimezone;
      sel.addEventListener('change', () => { selectedTimezone = sel.value; lastGreetingBlock = null; updateDate(); updateClock(); });
    }

    // ===== Visibility/focus =====
    function handleVisibilityChange() {
      if (!document.hidden) syncAccurateTime().finally(() => { updateDate(); updateClock(); });
    }

    // ===== Init =====
    async function init() {
      createClockFace();
      setRandomQuote();
      applyInitialTimezoneSelect();

      await syncAccurateTime();
      layoutDial(); // initial geometry
      updateDate(); updateClock();

      watchResize();           // keep geometry correct when squeezed
      startClockTicker();      // aligned seconds
      startDateTicker();       // aligned minutes

      setInterval(syncAccurateTime, RESYNC_MIN * 60 * 1000);
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('focus', () => { syncAccurateTime().finally(() => { updateDate(); updateClock(); }); });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
